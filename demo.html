<!DOCTYPE HTML>
<html>
    <!-- we cock. dick. BALLING. -->
    <!-- this is a barebones demo, not for actual use -->
    <head>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
        <title>bftranspile demo</title>
        <meta charset="utf-8">
        <style>
            body {
                margin-left: 5vw;
                margin-right: 5vw;
                margin-top: 5vh;
                margin-bottom: 5vh;
            }
        </style>
    </head>
    <body>
    <h1 style="text-align: center">bftranspile</h1>
    <h3 style="text-align: center">a simple browser demo</h3>
    <p>Output:</p>
    <pre><code id="output">You haven't run anything yet!</code></pre>
        <textarea placeholder="User input..." id="input"></textarea><br>
        <textarea placeholder="Brainfuck..." id="brainfuck"></textarea><br>
        <button onclick="run()">Run</button>
    </body>
    <script src="libtrans.js">
    </script>
    <script>
        /*
            GET HIM, HE ISN'T CIRCUMCISED!
         */
        let inputindex = -1;
        let inputbuf = "";
        let start = 0;
        let end = 0;
        let running = false;

        function endMePlease(msg = "") {
            end = performance.now();
            if (document.getElementById("output").innerHTML.endsWith("<br>")) document.getElementById("output").innerHTML = document.getElementById("output").innerHTML.replace(/<br>$/, "");
            document.getElementById("output").innerHTML += `<br>${msg}${msg !== "" ? "<br>" : ""}Execution finished in ${Math.floor((end - start) * 100) / 100}ms.`;
            running = false;
        }

        function o(code) {
            // a little \a for you ;)
            if (code === 7) {
                setTimeout(() => {
                    let audio = new Audio("beep.mp3");
                    audio.play();
                }, 0);
                return;
            }
            // easter egg: JS converts this to U+FFFF for some reason but it's not allocated
            // so we can safely put it here
            else if (code === -1) {
                setTimeout(() => {
                    let audio = new Audio("easteregg.mp3");
                    audio.play();
                }, 0);
                return;
            }
            document.getElementById("output").innerHTML += String.fromCharCode(code).replace(" ", "&nbsp;").replace("\n", "<br>");
        }

        function i() {
            inputindex++;
            if (inputbuf[inputindex]) return inputbuf.charCodeAt(inputindex);
            else {
                endMePlease();
                fail; // i haven't found a better way to stop the transpiled code :/
            }
        }

        function run() {
            if (running) return;
            running = true;
            inputindex = -1;
            inputbuf = document.getElementById("input").value;
            document.getElementById("output").innerHTML = "Starting execution...<br>";
            let program = document.getElementById("brainfuck").value;
            start = performance.now();
            try {
                eval(window.bftranspile.transpiler(program, ""));
            }
            catch (e) {
                if (e.toString() === "ReferenceError: fail is not defined") return;
                msg = `Failed with error:<br>${e}<br>`;
                switch (e.toString()) {
                    case "SyntaxError: missing } in compound statement": msg += "Hint: You likely have an unmatched [."; break;
                    case "SyntaxError: expected expression, got '}'": msg += "Hint: You likely have an extra ]."; break;
                    default: msg += "No hints found. (Report this to parabirb@protonmail.ch: this should not happen.)"; break;
                }
                endMePlease(msg);
                // this works. why?
                return;
            }
            endMePlease();
        }

        textareas = document.querySelectorAll("textarea");
        textareas.forEach(textarea => textarea.addEventListener("input", autoResize, false));

        function autoResize() {
            this.style.height = "auto";
            this.style.height = this.scrollHeight + "px";
        }
    </script>
</html>